<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Emacsbridge: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Emacsbridge
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Emacsbridge Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#working_with_core">Working with the core</a><ul><li class="level2"><a href="#qt_requirementsQt">requirements</a></li>
<li class="level2"><a href="#preparing_sources">Preparing the sources</a></li>
<li class="level2"><a href="#buildhelper">Build helper</a></li>
<li class="level2"><a href="#debugging">Debugging</a></li>
</ul>
</li>
<li class="level1"><a href="#architecture">Architecture</a><ul><li class="level2"><a href="#connection_setup">Connection setup</a></li>
<li class="level2"><a href="#urls">URLs</a><ul><li class="level3"><a href="#icons">/icons</a></li>
<li class="level3"><a href="#lisp">/lisp</a></li>
<li class="level3"><a href="#rpc">/rpc</a><ul><li class="level4"><a href="#addComponent">addComponent</a></li>
<li class="level4"><a href="#setData">setData</a></li>
<li class="level4"><a href="#notification">notification</a></li>
<li class="level4"><a href="#intent">intent</a></li>
<li class="level4"><a href="#sensor">sensor</a></li>
<li class="level4"><a href="#removeComponent">removeComponent</a></li>
</ul>
</li>
<li class="level3"><a href="#settings">/settings</a></li>
<li class="level3"><a href="#test_connection">/test_connection</a></li>
</ul>
</li>
</ul>
</li>
<li class="level1"><a href="#preparing_build_env">Preparing the build environment</a><ul><li class="level2"><a href="#android_builds">Android builds</a></li>
<li class="level2"><a href="#windows_builds">Windows builds</a></li>
</ul>
</li>
<li class="level1"><a href="#resources">Resources</a><ul><li class="level2"><a href="#android">Android</a></li>
<li class="level2"><a href="#qt">Qt</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="working_with_core"></a>
Working with the core</h1>
<h2><a class="anchor" id="qt_requirementsQt"></a>
requirements</h2>
<p>The following table contains the Qt versions suitable for compiling emacsbridge:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">OS </th><th class="markdownTableHeadNone">Version </th><th class="markdownTableHeadNone">State  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Android </td><td class="markdownTableBodyNone">5.15.1 </td><td class="markdownTableBodyNone">recommended  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Android </td><td class="markdownTableBodyNone">5.15.0 </td><td class="markdownTableBodyNone">minimum  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">PC </td><td class="markdownTableBodyNone">5.14.x </td><td class="markdownTableBodyNone">minimum  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">PC </td><td class="markdownTableBodyNone">5.15.x </td><td class="markdownTableBodyNone">recommended  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">PC </td><td class="markdownTableBodyNone">5.13.0 </td><td class="markdownTableBodyNone">compiles, works mostly, but not recommended  </td></tr>
</table>
<p>For building on PC compiling Qt is straightforward, and your distribution might already have a correct version. The following packages should pull in all the other required dependencies for building:</p>
<ul>
<li>Qt5Quick</li>
<li>Qt5QuickControls2</li>
<li>Qt5WebSockets</li>
<li>Qt5RemoteObjects</li>
<li>Qt5Network</li>
<li>Qt5Sensors</li>
<li>libQt5Core-private-headers-devel</li>
</ul>
<p>The package names are for OpenSuSE, other distributions should have similar naming.</p>
<p>To build for Android an Android development environment needs to be set up. It should work with Android Studio or similar, below is a summary on how to setup a non-GUI build environment.</p>
<h2><a class="anchor" id="preparing_sources"></a>
Preparing the sources</h2>
<p>Emacsbridge requires qthttpserver, which is included as a submodule. qthttpserver also has submodules. The following snippet clones the repository and initializes all submodules:</p>
<div class="fragment"><div class="line">$ git clone https://github.com/aardsoft/emacsbridge.git</div>
<div class="line">$ cd emacsbridge</div>
<div class="line">$ git submodule update --init --recursive qthttpserver</div>
</div><!-- fragment --><p>Now the code can be configured for qmake - for Android the qmake from inside the Android Qt tree needs to be called.</p>
<h2><a class="anchor" id="buildhelper"></a>
Build helper</h2>
<p>The source repository contains a build helper (<code>build.sh</code>). Outside of simple Linux builds using that might be easiest.</p>
<p>Variables controlling the build include:</p><ul>
<li>ANDROID_ABIS: ABIs to build, default <code>arm64-v8a x86_64 armeabi-v7a</code></li>
<li>ANDROID_SDK_VERSION: Android SDK version to use, default <code>android-29</code>. When targetting Play store the version from the script generally is the one which has to be used.</li>
<li>QT_VERSION: The Qt version used for trying to find directories, default <code>5.15.1</code> </li>
<li>QT_ANDROID_BIN: The bin directory inside of the Qt Android installation, defaulting to <code>$HOME/qt/qt${QT_VERSION}-${ANDROID_SDK_VERSION}/bin</code> </li>
<li>QT_WINDOWS_BIN: The bin directory inside of the Windows Qt installation, defaulting to <code>$HOME/qt/qt${QT_VERSION}-mingw64/bin</code> </li>
<li>WIN32_OBJDUMP: The name of the objdump binary for Windows, default <code>x86_64-w64-mingw32-objdump</code> </li>
<li>WIN32_SYSROOT: Path to the mingw32 sysroot, default <code>/usr/x86_64-w64-mingw32/sys-root/mingw/bin</code> </li>
<li>WIN32_PLUGINS: List of win32 plugins to use, default <code>platforms</code> </li>
<li>BUILD_DIR: Name of the build directory, default <code>build</code> </li>
<li>QMAKE_CXX: The C++ compiler to use for PC, default <code>clang++</code> </li>
<li>QMAKE_LINK: The linker to use for PC, default <code>clang++</code> </li>
</ul>
<h2><a class="anchor" id="debugging"></a>
Debugging</h2>
<p>To see what goes over the local socket, start socat and adjust socket address:</p>
<div class="fragment"><div class="line">while true; do echo &quot;Restart.&quot;; socat -v GOPEN:/tmp/Emacs1000/server UNIX-LISTEN:/tmp/es; done</div>
</div><!-- fragment --><p>Building for Android and Windows requires a proper cross-compiled toolchain,</p>
<h1><a class="anchor" id="architecture"></a>
Architecture</h1>
<p>The application is separated into a client and a server part, communicating via <a href="https://doc.qt.io/qt-5/qtremoteobjects-index.html">Qt Remote Objects</a></p>
<h2><a class="anchor" id="connection_setup"></a>
Connection setup</h2>
<p>Emacsbridge starts up with some open settings endpoints to make initial configuration easier. To set the connection up,</p>
<ul>
<li>Emacs provides information about its server connection</li>
<li>Emacsbridge uses that to connect to Emacs. If that connection was successful it will disable the open endpoints, and make the RPC interface available.</li>
</ul>
<h2><a class="anchor" id="urls"></a>
URLs</h2>
<h3><a class="anchor" id="icons"></a>
/icons</h3>
<p>Icons bundled with the application. Served without modification, directory index is enabled. No authentication required.</p>
<h3><a class="anchor" id="lisp"></a>
/lisp</h3>
<p>Lisp files bundled with the application. Served without modification, directory index is enabled. No authentication required.</p>
<h3><a class="anchor" id="rpc"></a>
/rpc</h3>
<p>Expects JSON data in a POST request, with a valid auth token. The method for which JSON data is sent must be specified in the <code>method</code> header. Only available after initial setup has been completed. The following methods are available:</p>
<h4><a class="anchor" id="addComponent"></a>
addComponent</h4>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">name </th><th class="markdownTableHeadNone">required </th><th class="markdownTableHeadNone">default  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">in-drawer </td><td class="markdownTableBodyNone">no </td><td class="markdownTableBodyNone">false  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">qmlData </td><td class="markdownTableBodyNone">yes </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">qmlFile </td><td class="markdownTableBodyNone">yes </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">title </td><td class="markdownTableBodyNone">no </td><td class="markdownTableBodyNone"><code>qmlFile</code>   </td></tr>
</table>
<h4><a class="anchor" id="setData"></a>
setData</h4>
<h4><a class="anchor" id="notification"></a>
notification</h4>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">name </th><th class="markdownTableHeadNone">required </th><th class="markdownTableHeadNone">default  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">title </td><td class="markdownTableBodyNone">no </td><td class="markdownTableBodyNone">"Missing notification title"  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">text </td><td class="markdownTableBodyNone">no </td><td class="markdownTableBodyNone">"Missing notification text"  </td></tr>
</table>
<h4><a class="anchor" id="intent"></a>
intent</h4>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">name </th><th class="markdownTableHeadNone">required </th><th class="markdownTableHeadNone">default  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">action </td><td class="markdownTableBodyNone">no </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">data </td><td class="markdownTableBodyNone">no </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">package </td><td class="markdownTableBodyNone">no </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">class </td><td class="markdownTableBodyNone">no </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">extra </td><td class="markdownTableBodyNone">no </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">startType </td><td class="markdownTableBodyNone">no </td><td class="markdownTableBodyNone">"activity"  </td></tr>
</table>
<div class="fragment"><div class="line">(emacsbridge-post-json &quot;intent&quot; (json-encode `((:package . &quot;com.termux&quot;)</div>
<div class="line">                                               (:startType . &quot;service&quot;)</div>
<div class="line">                                               (:class . &quot;com.termux.app.RunCommandService&quot;)</div>
<div class="line">                                               (:extra . (((:type . &quot;string&quot;)</div>
<div class="line">                                                           (:key . &quot;com.termux.RUN_COMMAND_PATH&quot;)</div>
<div class="line">                                                           (:value . &quot;/data/data/com.termux/files/usr/bin/ps&quot;))</div>
<div class="line">                                                          ((:type . &quot;stringarray&quot;)</div>
<div class="line">                                                           (:key . &quot;com.termux.RUN_COMMAND_ARGUMENTS&quot;)</div>
<div class="line">                                                           (:value . (((:value . &quot;a&quot;))</div>
<div class="line">                                                                      ((:value . &quot;x&quot;)))))))</div>
<div class="line">                                               (:action . &quot;com.termux.RUN_COMMAND&quot;))))</div>
</div><!-- fragment --><h4><a class="anchor" id="sensor"></a>
sensor</h4>
<h4><a class="anchor" id="removeComponent"></a>
removeComponent</h4>
<h3><a class="anchor" id=""></a>
</h3>
<p>Shell scripts bundled with the application. Served with simple template expansion, directory index is enabled. </p>
<h3><a class="anchor" id="settings"></a>
/settings</h3>
<h3><a class="anchor" id="test_connection"></a>
/test_connection</h3>
<p>Returns a page reporting the setup status of the connection to Emacs in human friendly text. No authentication required.</p>
<h1><a class="anchor" id="preparing_build_env"></a>
Preparing the build environment</h1>
<h2><a class="anchor" id="android_builds"></a>
Android builds</h2>
<p>First the directory structure gets prepared, and some variables need to be set. The SDK directory used here is <code>~/</code>.android/sdk:</p>
<div class="fragment"><div class="line">export ANDROID_SDK_ROOT=$HOME/.android/sdk</div>
<div class="line">export ANDROID_HOME=$HOME/.android/sdk</div>
<div class="line">mkdir -p $ANDROID_HOME</div>
</div><!-- fragment --><p>Next the command line tools need to be downloaded from <a href="https://developer.android.com/studio#downloads">the Android SDK download page</a> in the 'Command line tools only' section, and extracted:</p>
<div class="fragment"><div class="line">unzip -d $ANDROID_HOME ~/Downloads/commandlinetools-linux-6858069_latest.zip</div>
<div class="line">export PATH=$PATH:$ANDROID_HOME/cmdline-tools/tools/bin</div>
</div><!-- fragment --><p>Now sdkmanager can be used to initialize the SDK and download required packages:</p>
<div class="fragment"><div class="line">sdkmanager --verbose --licenses</div>
<div class="line">sdkmanager --update</div>
<div class="line">sdkmanager &quot;platforms;android-29&quot; &quot;ndk-bundle&quot; &quot;build-tools;30.0.2&quot; &quot;platform-tools&quot; &quot;tools&quot;</div>
</div><!-- fragment --><p>Next Qt needs to be Downloaded (<a href="http://download.qt.io/official_releases/qt/5.15/5.15.1/single/qt-everywhere-src-5.15.1.tar.xz.mirrorlist">5.15.1 mirror list</a>), extracted and built:</p>
<div class="fragment"><div class="line">tar xf qt-everywhere-src-5.15.1.tar.xz</div>
<div class="line">cd qt-everywhere-src-5.15.1</div>
<div class="line">./configure -opensource -confirm-license -android-abis armeabi-v7a,arm64-v8a,x86_64 -xplatform android-clang --disable-rpath -nomake tests -nomake examples -no-warnings-are-errors -android-ndk $HOME/.android/sdk/ndk-bundle -android-sdk $HOME/.android/sdk/platforms -android-ndk-platform android-29 -prefix $HOME/qt/qt5.15.1-android-29</div>
<div class="line">make -j$(nproc)</div>
<div class="line">make -j$(nproc) install</div>
</div><!-- fragment --><h2><a class="anchor" id="windows_builds"></a>
Windows builds</h2>
<p>The Windows version is highly experimental, seems to segfault due to issues with Qt remote objects, and probably won't see any work unless I'm very bored or somebody is interested in actually using it on Windows. Therefore the following just contains a few pointers for a chance to have a build environment.</p>
<p>A Visual Studio build might have the best chances to actually work, but probably will require code changes. MinGW compiles without code changes. On OpenSuSE probably the following packages are required:</p>
<ul>
<li>mingw64-cross-pkgconf</li>
<li>mingw64-libicu-devel</li>
<li>mingw64-angleproject-devel</li>
<li>mingw64-cross-binutils</li>
<li>mingw64-cross-gcc</li>
<li>mingw64-cross-gcc-c++</li>
<li>mingw64-cross-pkg-config</li>
<li>mingw64-dbus-1-devel</li>
<li>mingw64-filesystem</li>
<li>mingw64-libicu-devel</li>
<li>mingw64-libjpeg-devel</li>
<li>mingw64-libopenssl-devel</li>
<li>mingw64-libpng-devel</li>
<li>mingw64-libtiff-devel</li>
<li>mingw64-mysql-connector-c-devel</li>
<li>mingw64-pcre-devel</li>
<li>mingw64-sqlite-devel</li>
<li>mingw64-zlib-devel</li>
<li>mingw64-libharfbuzz-devel</li>
<li>mingw64-glib2-devel</li>
<li>mingw64-libintl-devel</li>
</ul>
<p>With those installed this should provide a more or less working build of Qt for Windows:</p>
<div class="fragment"><div class="line">rm -Rf qtactiveqt</div>
<div class="line">./configure -opensource -confirm-license -xplatform win32-g++ -device-option CROSS_COMPILE=x86_64-w64-mingw32- -nomake examples -release -make tools -prefix $HOME/qt/qt5.15.0-mingw64 -opengl desktop -skip qtlocation -skip qtactiveqt</div>
</div><!-- fragment --><h1><a class="anchor" id="resources"></a>
Resources</h1>
<h2><a class="anchor" id="android"></a>
Android</h2>
<ul>
<li><a href="https://developer.android.com/guide/topics/providers/contacts-provider">Android contacts provider</a></li>
<li><a href="https://developers.google.com/maps/documentation/urls/guide">Google Maps URL schemes</a></li>
<li><a href="https://developer.android.com/training/sync-adapters">Android sync adapters</a></li>
<li><a href="https://developer.android.com/guide/topics/providers/content-providers">Android content providers</a> </li>
</ul>
<h2><a class="anchor" id="qt"></a>
Qt</h2>
<ul>
<li><a href="https://www.qt.io/blog/2019/01/25/introducing-qt-http-server">Qt Http Server announcement</a></li>
<li><a href="https://bugreports.qt.io/browse/QTBUG-60105">QTBUG-60105 Lightweight HTTP server</a></li>
<li><a href="https://doc.qt.io/qt-5/qtremoteobjects-index.html">Qt Remote objects</a></li>
<li><a href="https://doc.qt.io/qt-5/android-services.html">Android services with Qt</a></li>
<li><a href="https://doc.qt.io/qt-5/qtandroidextras-index.html">Android extras</a> </li>
</ul>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
